# .github/workflows/swot-analyze.yml
#
# ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ SWOT-Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·:
# 1. ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ¿Ñ€Ğ¸ Ğ¿ÑƒÑˆĞµ
# 2. ĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ¸Ñ‚ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾ Ğ² Ñ€ĞµĞ¿Ğ¾
# 3. Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¸Ñ‚ ĞºÑ€Ğ°ÑĞ¸Ğ²ÑƒÑ Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ½Ğ° GitHub Pages

name: ğŸ¯ SWOT Analysis

on:
  push:
    paths:
      - 'analysis/*.md'
      - 'context.md'
    branches:
      - main
  
  workflow_dispatch:
    inputs:
      source_file:
        description: 'Ğ¤Ğ°Ğ¹Ğ» Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°'
        required: true
        default: 'analysis/company.md'

permissions:
  contents: write
  pages: write
  id-token: write

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  analyze:
    name: ğŸ“Š SWOT Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install Python dependencies
        run: |
          pip install anthropic langchain langchain-anthropic numpy
          pip install sentence-transformers || echo "âš ï¸ Ğ­Ğ¼Ğ±ĞµĞ´Ğ´Ğ¸Ğ½Ğ³Ğ¸ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹"

      - name: ğŸ” Find source file
        id: source
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            FILE="${{ github.event.inputs.source_file }}"
          else
            CHANGED=$(git diff --name-only HEAD~1 HEAD -- 'analysis/*.md' 2>/dev/null | head -1)
            FILE="${CHANGED:-analysis/company.md}"
          fi
          echo "file=$FILE" >> $GITHUB_OUTPUT
          echo "ğŸ“„ ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼: $FILE"

      - name: ğŸ¯ Run SWOT Analyzer
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python swot_analyzer.py "${{ steps.source.outputs.file }}" \
            --context context.md \
            --db swot.db \
            --outputs outputs

      - name: ğŸ’¾ Commit results
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add outputs/ swot.db
          
          if git diff --staged --quiet; then
            echo "ğŸ“­ ĞĞµÑ‚ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ°"
          else
            git commit -m "ğŸ¯ SWOT Analysis: $(date +'%Y-%m-%d %H:%M')"
            git push
            echo "âœ… Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ·Ğ°ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‡ĞµĞ½Ñ‹"
          fi

      - name: ğŸ“¤ Upload DB artifact
        uses: actions/upload-artifact@v4
        with:
          name: swot-database
          path: swot.db
          retention-days: 90

  deploy-docs:
    name: ğŸš€ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: analyze
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download database from analyze job
        uses: actions/download-artifact@v4
        with:
          name: swot-database
          path: .

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Install dependencies
        working-directory: swot-docs
        run: npm install

      - name: ğŸ”„ Generate MDX from database
        working-directory: swot-docs
        run: |
          if [ -f "../swot.db" ]; then
            npm run generate -- --db ../swot.db
            echo "âœ… MDX ÑĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½"
          else
            echo "âš ï¸ Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¿Ğ»ĞµĞ¹ÑÑ…Ğ¾Ğ»Ğ´ĞµÑ€Ñ‹"
          fi

      - name: ğŸ—ï¸ Build Docusaurus
        working-directory: swot-docs
        env:
          DOCUSAURUS_URL: https://${{ github.repository_owner }}.github.io
          DOCUSAURUS_BASE_URL: /${{ github.event.repository.name }}/
        run: npm run build

      - name: ğŸ“„ Setup Pages
        uses: actions/configure-pages@v4

      - name: ğŸ“¤ Upload to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: swot-docs/build

      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: âœ… Done
        run: |
          echo "ğŸ‰ Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾!"
          echo "ğŸ“Š SWOT: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
